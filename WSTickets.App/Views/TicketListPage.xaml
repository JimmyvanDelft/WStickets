<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="WSTickets.App.Views.TicketListPage"
             xmlns:behaviors="clr-namespace:CommunityToolkit.Maui.Behaviors;assembly=CommunityToolkit.Maui"
             Title="All Tickets"
             xmlns:model="clr-namespace:WSTickets.App.Models"
             xmlns:viewmodel="clr-namespace:WSTickets.App.ViewModels"
             x:DataType="viewmodel:TicketListViewModel">

    <Grid>
        <RefreshView Command="{Binding RefreshCommand}" IsRefreshing="{Binding IsRefreshing}">
            <StackLayout>
                <Label Text="No tickets assigned to you, create one by clicking on the plus button"
                       HorizontalOptions="Center"
                       VerticalOptions="Center"
                       TextColor="Gray"
                       FontAttributes="Italic"
                       IsVisible="{Binding NoTicketsMessageVisible}" />

                <Label Text="{Binding ErrorMessage}" 
                       TextColor="Red"
                       IsVisible="{Binding HasError}"
                       HorizontalOptions="Center"
                       Margin="10"/>

                <CollectionView ItemsSource="{Binding Tickets}" SelectionMode="None">
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="model:Ticket">
                            <Frame Margin="10" Padding="12" BorderColor="#ddd" CornerRadius="12" HasShadow="True">
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer 
                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:TicketListViewModel}}, Path=GoToTicketCommand}"
                                        CommandParameter="{Binding .}" />
                                </Frame.GestureRecognizers>

                                <VerticalStackLayout Spacing="6">
                                    <!-- TODO reporter and company -->
                                    <HorizontalStackLayout VerticalOptions="Center" Spacing="10">
                                        <BoxView WidthRequest="8" HeightRequest="8" BackgroundColor="{StaticResource Primary}" CornerRadius="4"/>
                                        <Label Text="{Binding ReporterId}" FontSize="13" TextColor="Gray"/>
                                    </HorizontalStackLayout>

                                    <!-- Title -->
                                    <Label Text="{Binding Title}" FontAttributes="Bold" FontSize="16" TextColor="Black"/>

                                    <!-- Description -->
                                    <Label Text="{Binding Description}" FontSize="13" TextColor="#555" LineBreakMode="TailTruncation" MaxLines="2"/>

                                    <!-- Ticket ID and Status -->
                                    <HorizontalStackLayout Spacing="10" Padding="0,4,0,0">
                                        <Label Text="{Binding Id, StringFormat='#\{0\}'}"
                                               FontSize="12"
                                               TextColor="DarkGray"
                                               BackgroundColor="#F0F0F0"
                                               Padding="6,2"/>
                                        <Image Source="{Binding Priority, Converter={StaticResource PriorityToImageConverter}}"
                                               HeightRequest="24"
                                               WidthRequest="24"
                                               VerticalOptions="Center"/>
                                        <Label Text="{Binding CurrentStatus}"
                                               FontSize="12"
                                               TextColor="White"
                                               BackgroundColor="{Binding CurrentStatus, Converter={StaticResource StatusToColorConverter}}"
                                               Padding="6,2"/>
                                    </HorizontalStackLayout>


                                </VerticalStackLayout>
                            </Frame>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </StackLayout>
        </RefreshView>

        <!-- Floating Add Button -->
        <Button Text="+"
                FontSize="28"
                WidthRequest="60"
                HeightRequest="60"
                CornerRadius="30"
                BackgroundColor="{StaticResource Primary}"
                TextColor="White"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="20"
                Clicked="OnNewTicketButtonClicked"/>
    </Grid>
</ContentPage>
