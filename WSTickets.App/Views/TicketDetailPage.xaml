<ContentPage x:Class="WSTickets.App.Views.TicketDetailPage"
	xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
	xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
	xmlns:viewmodel="clr-namespace:WSTickets.App.ViewModels"
	xmlns:material="clr-namespace:UraniumUI.Material.Controls;assembly=UraniumUI.Material"
	xmlns:model="clr-namespace:WSTickets.App.Models"
            x:Name="ThisPage"
            Title="{Binding Ticket.Id, StringFormat='Ticket #{0}'}"
            x:DataType="viewmodel:TicketDetailViewModel">

    <ScrollView>

        <VerticalStackLayout Padding="20,0,20,20" Spacing="12">

            <Label Text="{Binding Ticket.Title}" FontSize="20" FontAttributes="Bold" />

            <Label Text="{Binding Ticket.Description}" FontSize="14" TextColor="Gray" />

            <Label Text="Priority:" FontAttributes="Bold" />

            <!-- If CanEditTicket is true, show dropdown -->

            <material:DropdownField
            x:Name="PriorityDropdown"
            ItemsSource="{Binding PriorityOptions}"
            SelectedItem="{Binding SelectedPriority, Mode=TwoWay}"
            IsVisible="{Binding CanEditTicket}" />

            <!-- Otherwise, show readonly text -->

            <Label Text="{Binding Ticket.Priority}" 
                    TextColor="Gray"
       IsVisible="{Binding CanEditTicket, Converter={StaticResource InverseBoolConverter}}" />

            <Label Text="Status:" FontAttributes="Bold" />

            <material:DropdownField
                x:Name="StatusDropdown"
                ItemsSource="{Binding StatusOptions}"
                SelectedItem="{Binding SelectedStatus, Mode=TwoWay}"
                IsVisible="{Binding CanEditTicket}" />

            <Label Text="{Binding Ticket.CurrentStatus}" 
                    TextColor="Gray"
       IsVisible="{Binding CanEditTicket, Converter={StaticResource InverseBoolConverter}}" />

            <!-- Attachments -->

            <Label Text="Attachments" FontAttributes="Bold" FontSize="Medium" />

            <CollectionView ItemsSource="{Binding Attachments}">

                <CollectionView.ItemsLayout>

                    <LinearItemsLayout Orientation="Horizontal" ItemSpacing="5" />

                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>

                    <DataTemplate x:DataType="model:Attachment">

                        <VerticalStackLayout WidthRequest="120" HorizontalOptions="Center">

                            <!-- Thumbnail with rounded corners -->

                            <Frame Padding="0" CornerRadius="16" HeightRequest="120" WidthRequest="120" HorizontalOptions="Center">

                                <Image Aspect="AspectFit" HeightRequest="120" WidthRequest="120">

                                    <Image.Source>

                                        <UriImageSource Uri="{Binding FilePath}" CachingEnabled="True" CacheValidity="1:00:00" />

                                    </Image.Source>

                                    <Image.GestureRecognizers>

                                        <TapGestureRecognizer 
                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodel:TicketDetailViewModel}}, Path=OpenImageCommand}" 
                                CommandParameter="{Binding FilePath}" />

                                    </Image.GestureRecognizers>

                                </Image>

                            </Frame>

                            <!-- Metadata -->

                            <Label Text="{Binding UploadedAt, StringFormat='{0:dd-MM-yyyy HH:mm}'}" Padding="0,8,0,0" FontSize="10" TextColor="Gray" HorizontalTextAlignment="Center" LineBreakMode="TailTruncation" />

                        </VerticalStackLayout>

                    </DataTemplate>

                </CollectionView.ItemTemplate>

            </CollectionView>

            <!-- Messages -->

            <Label Text="Messages" FontAttributes="Bold" FontSize="Medium" />

            <CollectionView ItemsSource="{Binding Messages}">

                <CollectionView.ItemTemplate>

                    <DataTemplate x:DataType="model:Message">

                        <HorizontalStackLayout
        Padding="0,10,0,10"
        Spacing="5">

                            <!-- 1) Flip the row left/right based on IsFromReporter -->

                            <HorizontalStackLayout.Triggers>

                                <DataTrigger
            TargetType="HorizontalStackLayout"
            Binding="{Binding IsFromReporter}"
            Value="False">

                                    <Setter Property="FlowDirection" Value="RightToLeft" />

                                </DataTrigger>

                            </HorizontalStackLayout.Triggers>

                            <!-- 2) Avatar -->

                            <Image
          HeightRequest="36"
          WidthRequest="36"
          VerticalOptions="Start"
          Aspect="AspectFill">

                                <!-- round mask -->

                                <Image.Clip>

                                    <EllipseGeometry
              Center="18,18"
              RadiusX="18"
              RadiusY="18" />

                                </Image.Clip>

                                <!-- switch source via triggers -->

                                <Image.Triggers>

                                    <DataTrigger
              TargetType="Image"
              Binding="{Binding IsFromReporter}"
              Value="True">

                                        <Setter Property="Source" Value="reporter_profile.png" />

                                    </DataTrigger>

                                    <DataTrigger
              TargetType="Image"
              Binding="{Binding IsFromReporter}"
              Value="False">

                                        <Setter Property="Source" Value="developer_profile.png" />

                                    </DataTrigger>

                                </Image.Triggers>

                            </Image>

                            <!-- 3) Message + meta -->

                            <VerticalStackLayout HorizontalOptions="FillAndExpand" Spacing="4">

                                <!-- bubble with coloured background -->

                                <Frame
            Padding="10"
            CornerRadius="12"
            HasShadow="False">

                                    <Frame.Triggers>

                                        <DataTrigger
                TargetType="Frame"
                Binding="{Binding IsFromReporter}"
                Value="True">

                                            <Setter Property="BackgroundColor" Value="#DCF2FF" />

                                        </DataTrigger>

                                        <DataTrigger
                TargetType="Frame"
                Binding="{Binding IsFromReporter}"
                Value="False">

                                            <Setter Property="BackgroundColor" Value="#E6E6E6" />

                                        </DataTrigger>

                                    </Frame.Triggers>

                                    <Label Text="{Binding Content}" FontSize="13" />

                                </Frame>

                                <!-- time row -->

                                <Label
              Text="{Binding Timestamp, StringFormat='{0:t}'}"
              FontSize="10"
              TextColor="Gray"
              HorizontalOptions="EndAndExpand" />

                            </VerticalStackLayout>

                        </HorizontalStackLayout>

                    </DataTemplate>

                </CollectionView.ItemTemplate>

            </CollectionView>

            <HorizontalStackLayout 
                    Grid.Row="2"
                    Spacing="10"
                    VerticalOptions="End">

                <Entry
                    Text="{Binding NewMessageContent}"
                    Placeholder="Type your message..." />

                <Button
                    Text="Send"
                    Command="{Binding SendMessageCommand}"
                    IsEnabled="{Binding IsSendEnabled}" />

                <Button
                    Text="Add attachment"
                    Command="{Binding AddAttachmentCommand}" />

            </HorizontalStackLayout>

            <!-- Status History -->

            <Label Text="Status History" FontAttributes="Bold" FontSize="Medium" />

            <CollectionView ItemsSource="{Binding StatusHistory}" HeightRequest="150">

                <CollectionView.ItemTemplate>

                    <DataTemplate x:DataType="model:StatusHistory">

                        <Frame Margin="5" Padding="5" BorderColor="LightGray" CornerRadius="6">

                            <VerticalStackLayout>

                                <Label Text="{Binding Status}" />

                                <Label Text="{Binding Timestamp}" FontSize="12" TextColor="Gray" />

                            </VerticalStackLayout>

                        </Frame>

                    </DataTemplate>

                </CollectionView.ItemTemplate>

            </CollectionView>

        </VerticalStackLayout>

    </ScrollView>

</ContentPage>